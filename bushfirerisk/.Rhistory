group_by(year, industry_section) %>%
summarise(median_profit = median(net_profit, na.rm = TRUE), .groups = "drop") %>%
mutate(country = "Cayman Islands")
# --- Brazil ---
brazil_pro <- osiris_all_brazil %>%
mutate(
year = parse_integer(as.character(year)),
industry_section = as.character(industry_section)
) %>%
group_by(year, industry_section) %>%
summarise(median_profit = median(net_profit, na.rm = TRUE), .groups = "drop") %>%
mutate(country = "Brazil")
# --- Combine & order ---
plotdf_p <- bind_rows(cayman_pro, brazil_pro) %>%
filter(!is.na(median_profit), !is.na(year), !is.na(industry_section)) %>%
mutate(
year = factor(year),
country = factor(country, levels = c("Cayman Islands", "Brazil"))
)
industry_order_p <- plotdf_p %>%
group_by(industry_section) %>%
summarise(order_stat = median(median_profit, na.rm = TRUE), .groups = "drop") %>%
arrange(order_stat) %>%
pull(industry_section)
plotdf_p <- plotdf_p %>%
mutate(
industry_section = factor(industry_section, levels = industry_order_p),
tooltip_txt = paste0(
"Country: ", country,
"\nIndustry: ", industry_section,
"\nYear: ", year,
"\nMedian Profit: ", comma(median_profit)
),
key_id = interaction(country, industry_section, year, drop = TRUE)
)
p_profit_all <- ggplot(plotdf_p, aes(x = industry_section, y = median_profit, fill = year)) +
geom_col_interactive(aes(tooltip = tooltip_txt, data_id = key_id),
position = position_dodge(width = 0.9)) +
coord_flip() +
facet_grid(country ~ ., switch = "y") +
labs(
title = "Median Profits by Industry",
x = "Industry", y = "Median Profit", fill = "Year"
) +
theme_bw() +
theme(
aspect.ratio = 1,
strip.placement = "outside",
strip.text.y.left = element_text(angle = 0, face = "bold", size = 10),
axis.text.y = element_text(size = 10),
axis.text.x = element_text(size = 10),
axis.title = element_text(size = 10),
plot.title = element_text(size = 15, face = "bold"),
legend.text = element_text(size = 10),
legend.title = element_text(size = 10)
)
girafe(
ggobj = p_profit_all,
width_svg = 12.5, height_svg = 8
)
#| label: fig-profit-focus
#| fig-cap: "Median profits by selected industries, Cayman Islands and Brazil (2018–2021)"
#| warning: false
#| message: false
library(dplyr)
library(tidyr)
library(readr)
library(forcats)
library(ggplot2)
library(ggiraph)
library(scales)
focus_industries <- c(
"E  Electricity, gas & water",
"A  Agriculture, forestry",
"G  Wholesale & retail trade; repair",
"K  Real estate, renting & business",
"J  Financial intermediation",
"H  Hotels & restaurants",
"C  Mining & quarrying"
)
# --- Cayman (focus) ---
cayman_p_focus <- osiris_clean %>%
mutate(
year = parse_integer(as.character(year)),
industry_section = as.character(industry_section)
) %>%
filter(industry_section %in% focus_industries) %>%
group_by(year, industry_section) %>%
summarise(median_profit = median(net_profit, na.rm = TRUE), .groups = "drop") %>%
mutate(country = "Cayman Islands")
# --- Brazil (focus) ---
brazil_p_focus <- osiris_all_brazil %>%
mutate(
year = parse_integer(as.character(year)),
industry_section = as.character(industry_section)
) %>%
filter(industry_section %in% focus_industries) %>%
group_by(year, industry_section) %>%
summarise(median_profit = median(net_profit, na.rm = TRUE), .groups = "drop") %>%
mutate(country = "Brazil")
plot_p_focus <- bind_rows(cayman_p_focus, brazil_p_focus) %>%
filter(!is.na(median_profit)) %>%
mutate(
year = factor(year),
country = factor(country, levels = c("Cayman Islands", "Brazil"))
)
industry_order_pf <- plot_p_focus %>%
group_by(industry_section) %>%
summarise(order_stat = median(median_profit), .groups = "drop") %>%
arrange(order_stat) %>%
pull(industry_section)
plot_p_focus <- plot_p_focus %>%
mutate(
industry_section = factor(industry_section, levels = industry_order_pf),
tooltip_txt = paste0(
"Country: ", country,
"\nIndustry: ", industry_section,
"\nYear: ", year,
"\nMedian Profit: ", comma(median_profit)
),
key_id = interaction(country, industry_section, year, drop = TRUE)
)
p_profit_focus <- ggplot(plot_p_focus, aes(x = industry_section, y = median_profit, fill = year)) +
geom_col_interactive(aes(tooltip = tooltip_txt, data_id = key_id),
position = position_dodge(width = 0.9)) +
coord_flip() +
facet_grid(country ~ ., switch = "y") +
labs(
title = "Median Profits by Selected Industries",
x = "Industry", y = "Median Profit", fill = "Year"
) +
theme_bw() +
theme(
aspect.ratio = 1,
strip.placement = "outside",
strip.text.y.left = element_text(angle = 0, face = "bold", size = 9),
axis.text.y = element_text(size = 8),
plot.margin = margin(10, 12, 24, 12)
)
girafe(
ggobj = p_profit_focus,
width_svg = 12, height_svg = 7.5
)
#| label: tbl-cashflow-dir
#| tbl-cap: "Share of firms with CFO>0, CFI<0, and CFF>0 by year (Cayman Islands)."
cashflow_dir_summary <- osiris_clean |>
group_by(year) |>
summarise(
pct_cfo_positive = mean(op_cashflow > 0, na.rm = TRUE),
pct_cfi_negative = mean(inv_cashflow < 0, na.rm = TRUE),
pct_cff_positive = mean(fin_cashflow > 0, na.rm = TRUE),
.groups = "drop"
)
kable(cashflow_dir_summary,
col.names = c("Year", "CFO > 0", "CFI < 0", "CFF > 0"))
#| label: fig-cf-direction-comparison
#| fig-cap: "Share of firms with CFO>0, CFI<0, and CFF>0 by year (2018–2021), comparing Brazil and Cayman; y-axis shows proportions."
cashflow_cayman_long <- cashflow_dir_summary |>
mutate(year = as.integer(as.character(year))) |>
pivot_longer(
cols = starts_with("pct_"),
names_to = "metric",
values_to = "pct"
) |>
mutate(
metric = recode(
metric,
pct_cfo_positive = "CFO > 0",
pct_cfi_negative = "CFI < 0",
pct_cff_positive = "CFF > 0"
),
label = "Cayman"
)
cashflow_brazil_long <- osiris_all_brazil |>
group_by(year) |>
summarise(
pct_cfo_positive = mean(op_cashflow > 0, na.rm = TRUE),
pct_cfi_negative = mean(inv_cashflow < 0, na.rm = TRUE),
pct_cff_positive = mean(fin_cashflow > 0, na.rm = TRUE),
.groups = "drop"
) |>
mutate(year = as.integer(as.character(year))) |>
pivot_longer(
cols = starts_with("pct_"),
names_to = "metric",
values_to = "pct"
) |>
mutate(
metric = recode(
metric,
pct_cfo_positive = "CFO > 0",
pct_cfi_negative = "CFI < 0",
pct_cff_positive = "CFF > 0"
),
label = "Brazil"
)
cayman_brazil_cashflow <- bind_rows(cashflow_cayman_long, cashflow_brazil_long)
ggplot(cayman_brazil_cashflow, aes(x = year, y = pct, color = metric)) +
geom_line(linewidth = 1) +
geom_point(size = 2) +
scale_y_continuous(limits = c(0, 1),
labels = percent_format(accuracy = 1)) +
scale_x_continuous(breaks = sort(unique(cayman_brazil_cashflow$year))) +
labs(x = "Year", y = "Percentage of firms", color = "",
title = "Direction of Cash Flows by Year") +
facet_wrap(~ label, scales = "fixed") +
theme(legend.position = "bottom",
axis.text.x = element_text(size = 9))
cashflow_ratio <- osiris_clean |>
mutate(
cfo_revenue = if_else(revenue > 0, op_cashflow / revenue, NA_real_),
cfi_assets  = if_else(total_assets > 0, inv_cashflow / total_assets, NA_real_),
cff_assets  = if_else(total_assets > 0, fin_cashflow / total_assets, NA_real_)
)
#| label: fig-ratio-winsor
#| fig-cap: "Distribution of CFO/Revenue, CFI/Assets, and CFF/Assets by year in Cayman Islands (after 10%/90% winsorization)."
plot_ratio <- cashflow_ratio |>
select(year, cfo_revenue, cfi_assets, cff_assets) |>
pivot_longer(-year, names_to = "metric", values_to = "value") |>
group_by(metric) |>
mutate(
q10 = quantile(value, 0.10, na.rm = TRUE),
q90 = quantile(value, 0.90, na.rm = TRUE),
value_winsorized = pmin(pmax(value, q10), q90)
) |>
ungroup() |>
mutate(year = factor(year),
metric = factor(metric,
levels = c("cfo_revenue", "cfi_assets", "cff_assets"),
labels = c("CFO / Revenue", "CFI / Assets", "CFF / Assets")))
ggplot(plot_ratio, aes(x = year, y = value_winsorized, colour = year)) +
geom_boxplot() +
facet_wrap(~ metric, scales = "free_y") +
labs(x = "Year",
y = "Cash flow ratio",
title = "Distribution of cash flow ratios") +
theme(legend.position = "None",
axis.text.x = element_text(size = 9))
#| label: fig-cf-ratio-iqr-ribbon
#| fig-cap: "Median cash-flow ratios (lines) with IQR ribbons by year (2018–2021), faceted by country and ratio."
cashflow_ratio_brazil <- osiris_all_brazil |>
mutate(
year = factor(year),
cfo_revenue = if_else(revenue > 0, op_cashflow / revenue, NA_real_),
cfi_assets  = if_else(total_assets > 0, inv_cashflow / total_assets, NA_real_),
cff_assets  = if_else(total_assets > 0, fin_cashflow / total_assets, NA_real_)
) |>
mutate(country = "Brazil")
cashflow_ratio <- cashflow_ratio |>
mutate(country = "Cayman")
ratio_long <- bind_rows(cashflow_ratio_brazil, cashflow_ratio) |>
pivot_longer(
c(cfo_revenue, cfi_assets, cff_assets),
names_to  = "metric",
values_to = "value"
) |>
mutate(
metric = factor(metric,
levels = c("cfo_revenue","cfi_assets","cff_assets"),
labels = c("CFO / Revenue","CFI / Assets","CFF / Assets")),
year = as.integer(as.character(year)),
country = factor(country, levels = c("Brazil","Cayman"))
)
summary_by <- ratio_long |>
group_by(country, metric, year) |>
summarise(
med = median(value, na.rm = TRUE),
q10 = quantile(value, 0.10, na.rm = TRUE),
q90 = quantile(value, 0.90, na.rm = TRUE),
.groups = "drop"
)
ggplot(summary_by, aes(x = year, y = med, group = metric)) +
geom_ribbon(aes(ymin = q10, ymax = q90, fill = metric), alpha = 0.25) +
geom_line(aes(color = metric), linewidth = 1) +
geom_point(aes(color = metric), size = 2) +
labs(x = "Year", y = "Ratio", color = "Metric", fill = "Metric",
title = "Cash flow ratios by country") +
facet_grid(country ~ metric, scales = "free_y") +
theme_bw(base_size = 14) +
theme(legend.position = "bottom",
axis.text.x = element_text(size = 9))
#| label: fig-industry-boxplot-cfo
#| fig-cap: "CFO / Revenue by industry and year (Cayman Islands)."
ratio_cfo <- cashflow_ratio |>
select(year, industry_section, cfo_revenue) |>
filter(is.finite(cfo_revenue)) |>
group_by(year) |>
mutate(
q10      = quantile(cfo_revenue, 0.10, na.rm = TRUE),
q90      = quantile(cfo_revenue, 0.90, na.rm = TRUE),
cfo_plot = pmin(pmax(cfo_revenue, q10), q90)
) |>
ungroup()
short_labels <- setNames(
substr(levels(osiris_clean$industry_section), 1, 1),
levels(osiris_clean$industry_section)
)
ylims_cfo <- quantile(ratio_cfo$cfo_plot, c(0.02, 0.98), na.rm = TRUE)
ggplot(ratio_cfo,
aes(x = factor(year), y = cfo_plot, fill = factor(year))) +
geom_boxplot(outlier.alpha = 0.3, width = 0.65) +
facet_wrap(
~ industry_section,
ncol = 5,
labeller = labeller(industry_section = short_labels)
) +
coord_cartesian(ylim = ylims_cfo) +
scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
labs(
title = "CFO / Revenue by Industry",
x = NULL,
y = "CFO / Revenue (%)",
fill = "Year"
) +
theme_bw() +
theme(
aspect.ratio = 1,
legend.position = "bottom",
axis.text.x  = element_blank(),
strip.text   = element_text(size = 10, face = "bold"),
panel.spacing = grid::unit(6, "pt")
)
#| label: fig-cfo-focus
#| fig-cap: "Median operating CFO/Revenue for key industries (Cayman Islands)."
focus_industries <- c(
"H  Hotels & restaurants",
"I  Transport, storage & communication",
"J  Financial intermediation",
"K  Real estate, renting & business"
)
cfo_focus <- cashflow_ratio |>
filter(industry_section %in% focus_industries,
!is.na(cfo_revenue)) |>
group_by(year, industry_section) |>
summarise(
median_cfo = median(cfo_revenue, na.rm = TRUE),
.groups = "drop"
) |>
mutate(industry_short = substr(industry_section, 1, 1))
ggplot(cfo_focus,
aes(x = year,
y = median_cfo,
color = industry_short,
group = industry_short)) +
geom_line(size = 1.2) +
geom_point(size = 3) +
scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
labs(
title = "Median CFO / Revenue in Key Sectors",
x = "Year",
y = "Median CFO / Revenue (%)",
color = "Industry"
) +
theme_bw() +
theme(legend.position = "bottom")
#| label: fig-industry-boxplot-cfi
#| fig-cap: "CFI / Assets by industry and year (Cayman Islands)."
ratio_cfi <- cashflow_ratio |>
select(year, industry_section, cfi_assets) |>
filter(is.finite(cfi_assets)) |>
group_by(year) |>
mutate(
q10      = quantile(cfi_assets, 0.10, na.rm = TRUE),
q90      = quantile(cfi_assets, 0.90, na.rm = TRUE),
cfi_plot = pmin(pmax(cfi_assets, q10), q90)
) |>
ungroup()
ylims_cfi <- quantile(ratio_cfi$cfi_plot, c(0.02, 0.98), na.rm = TRUE)
ggplot(ratio_cfi,
aes(x = factor(year), y = cfi_plot, fill = factor(year))) +
geom_boxplot(outlier.alpha = 0.3, width = 0.65) +
facet_wrap(
~ industry_section,
ncol = 5,
labeller = labeller(industry_section = short_labels)
) +
coord_cartesian(ylim = ylims_cfi) +
scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
labs(
title = "CFI / Assets by Industry",
x = NULL,
y = "CFI / Assets (%)",
fill = "Year"
) +
theme_bw() +
theme(
aspect.ratio = 1,
legend.position = "bottom",
axis.text.x  = element_blank(),
strip.text   = element_text(size = 10, face = "bold"),
panel.spacing = grid::unit(6, "pt")
)
#| label: fig-cfi-focus
#| fig-cap: "Median CFI/Assets for key industries (Cayman Islands)."
focus_industries_cfi <- c(
"D  Manufacturing",
"F  Construction",
"K  Real estate, renting & business",
"J  Financial intermediation"
)
cfi_focus <- cashflow_ratio |>
filter(industry_section %in% focus_industries_cfi,
!is.na(cfi_assets)) |>
group_by(year, industry_section) |>
summarise(
median_cfi = median(cfi_assets, na.rm = TRUE),
q25 = quantile(cfi_assets, 0.25, na.rm = TRUE),
q75 = quantile(cfi_assets, 0.75, na.rm = TRUE),
.groups = "drop"
) |>
mutate(industry_short = substr(industry_section, 1, 1))
ggplot(cfi_focus, aes(x = year, y = median_cfi, color = industry_short, group = industry_short)) +
geom_line(size = 1.3) +
geom_point(size = 3) +
geom_ribbon(aes(ymin = q25, ymax = q75, fill = industry_short), alpha = 0.15, color = NA) +
scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
labs(
title = "Median CFI / Assets in Key Sectors",
x = "Year",
y = "Median CFI / Assets (%)",
color = "Industry", fill = "Industry"
) +
theme_bw() +
theme(
legend.position = "bottom",
strip.text = element_text(size = 11, face = "bold"),
panel.grid.minor = element_blank()
)
#| label: fig-industry-boxplot-cff
#| fig-cap: "Industry composition by year (CFF/Assets)"
cff_ind <- cashflow_ratio |>
select(year, industry_section, cff_assets) |>
filter(is.finite(cff_assets)) |>
group_by(year) |>
mutate(
q10      = quantile(cff_assets, 0.10, na.rm = TRUE),
q90      = quantile(cff_assets, 0.90, na.rm = TRUE),
cff_plot = pmin(pmax(cff_assets, q10), q90)
) |>
ungroup()
ylims_cff <- quantile(cff_ind$cff_plot, c(0.02, 0.98), na.rm = TRUE)
ggplot(cff_ind, aes(x = factor(year), y = cff_plot, fill = factor(year))) +
geom_boxplot(outlier.alpha = 0.3, width = 0.65) +
facet_wrap(
~ industry_section,
ncol = 5,
labeller = labeller(industry_section = short_labels)
) +
coord_cartesian(ylim = ylims_cff) +
scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
labs(
title = "CFF / Assets by Industry",
x = NULL, y = "CFF / Assets (%)", fill = "Year"
) +
theme_bw() +
theme(
aspect.ratio = 1,
legend.position = "bottom",
axis.text.x  = element_blank(),
strip.text   = element_text(size = 10, face = "bold"),
panel.spacing = grid::unit(6, "pt")
)
#| label: fig-cff-focus
#| fig-cap: fig-cap: "Median CFF/Assets for key industries (Cayman Islands)."
focus_cff <- c("J  Financial intermediation",
"K  Real estate, renting & business",
"F  Construction")
cff_selected <- cashflow_ratio |>
filter(industry_section %in% focus_cff, !is.na(cff_assets)) |>
group_by(year, industry_section) |>
summarise(median_cff = median(cff_assets, na.rm = TRUE), .groups = "drop") |>
mutate(industry_short = substr(industry_section, 1, 1))
ggplot(cff_selected, aes(x = year, y = median_cff, color = industry_short, group = industry_short)) +
geom_line(size = 1.3) +
geom_point(size = 3) +
scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
labs(title = "Median CFF / Assets in Key Sectors",
x = "Year", y = "Median CFF / Assets (%)",
color = "Industry") +
theme_bw() +
theme(legend.position = "bottom")
?bushfire_real
devtools::document()
~/Documents/Monash/ETC5523/Assignment4/assignment-4-packages-and-shiny-apps-zooriya/bushfirerisk/
getwd()
setwd("~/Documents/Monash/ETC5523/Assignment4/assignment-4-packages-and-shiny-apps-zooriya/bushfirerisk")
devtools::document()
devtools::load_all()
?bushfire_real
devtools::load_all()
?bushfire_real
devtools::document()
devtools::load_all()
?bushfire_real
devtools::document()
devtools::load_all()
?bushfire_real
rm(list = ls())
.rs.restartR()
devtools::document()
devtools::load_all()
data(bushfire_real)
head(bushfire_real)
plot_fwi(bushfire_real, var = "temp_c")
plot_fwi(bushfire_real, var = "wind_ms")
launch_app()
source("~/Documents/Monash/ETC5523/Assignment4/assignment-4-packages-and-shiny-apps-zooriya/bushfirerisk/data-raw/make_bushfire_data.R")
launch_app()
devtools::load_all()
launch_app()
devtools::load_all()
launch_app()
